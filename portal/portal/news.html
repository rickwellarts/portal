<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Atualizações — CCE 4.0</title>
  <link rel="stylesheet" href="/assets/style.css"/>
  <link rel="stylesheet" href="/assets/overrides-news.css"/>
  <style>
    /* garante imagens do editor responsivas */
    .news-body img { max-width: 100%; height: auto; border-radius: 8px; }
    .news-body iframe, .news-body video { max-width:100%; }
    .news-post { background: rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:16px; }
    .news-date { opacity:.7; margin-bottom:6px; }
  </style>
</head>
<body class="app-bg">
  <div id="nav-mount"></div>
  <main class="container">
    <div id="news-view"></div>
  </main>

  <span id="news-badge"></span>

  <script type="module">
    import { requireAuth } from '../assets/auth.js';
    import { renderNavbar, bindNavbar } from '../assets/ui.js';
    import { getNewsById, ensureWelcomeSeed } from '../assets/news.js';

    // 1) Sessão
    requireAuth();

    // 2) Navbar
    const navMount = document.getElementById('nav-mount');
    if (navMount) {
      navMount.innerHTML = renderNavbar('portal');
      bindNavbar();
    }

    // 3) Conteúdo do post
    ensureWelcomeSeed();
    const params = new URLSearchParams(location.search);
    const id = params.get('id');
    const post = id ? getNewsById(id) : null;

    const mount = document.getElementById('news-view');

    function isLikelyHtml(s){
      return typeof s === 'string' && /<\s*[a-z][\s\S]*>/i.test(s);
    }

    if (!post) {
      mount.innerHTML = `<p class="muted">Post não encontrado.</p>`;
    } else {
      // Prioriza HTML salvo pelo editor (SunEditor/TinyMCE)
      const raw =
        post.bodyHtml ??
        post.corpoHtml ??
        post.body ??
        '';

      // Se já é HTML, usa direto; se for texto puro, converte quebras de linha
      const bodyHtml = isLikelyHtml(raw) ? raw : String(raw).replace(/\n/g,'<br>');

      mount.innerHTML = `
        <article class="news-post">
          <div class="news-date">${new Date(post.ts).toLocaleDateString('pt-BR')}</div>
          <h1>${post.title || ''}</h1>
          ${post.subtitle ? `<h3>${post.subtitle}</h3>` : ''}
          <div class="news-body">${bodyHtml}</div>
          <p style="margin-top:12px;"><a href="./index.html">← Voltar para lista</a></p>
        </article>
      `;
    }
  </script>
</body>
</html>
