<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Portal CCE 4.0</title>

  <link rel="stylesheet" href="../assets/style.css" />
  <link rel="stylesheet" href="../assets/overrides-2025-10-07.css" />
  <link rel="stylesheet" href="/assets/overrides-news.css" />

  <!-- M√≥dulos principais -->
  <script type="module" src="../assets/ui.js"></script>


<script type="module">
  import { requireAuth } from '/assets/auth.js';
  import { renderNavbar, bindNavbar } from '/assets/ui.js';

  requireAuth().then(()=>{
    const mount = document.getElementById('nav-mount');
    
    bindNavbar();
  });
</script>




  <style>
    /* Estilo do novo feed com thumbnails */
    .feed-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 16px;
      margin-top: 20px;
    }

    .feed-card {
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 14px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transition: transform .2s ease, box-shadow .2s ease;
    }

    .feed-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 4px 12px rgba(0,0,0,.25);
    }

    .feed-thumb {
      width: 100%;
      aspect-ratio: 16/9;
      object-fit: cover;
      display: block;
      background: rgba(255,255,255,.04);
      border-bottom: 1px solid rgba(255,255,255,.06);
    }

    .feed-body {
      padding: 14px 16px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .feed-title {
      font-weight: 700;
      font-size: 1.05rem;
    }

    .feed-sub {
      opacity: .85;
      font-size: .95rem;
    }

    .feed-meta {
      opacity: .65;
      font-size: .85rem;
      margin-top: 2px;
    }

    .feed-actions {
      margin-top: 10px;
    }

    .feed-actions .btn {
      padding: 6px 10px;
      border-radius: 10px;
    }
  </style>
</head>

<body>
  <!-- Navbar -->
  <div id="nav-mount"></div>

  <main class="container">
    <h1>Portal CCE</h1>
    <section id="news-feed"></section>

    <!-- Mascote fixo -->
    <img id="news-mascot" class="mascote" src="/assets/dicas.png" alt="Dicas e avisos">
    <span id="news-badge"></span>
  </main>

  <!-- Script principal -->
  <script type="module">
    import { requireAuth } from '../assets/auth.js';
    import { ensureWelcomeSeed, initMascotNotifier, listNews } from '../assets/news.js';
    import { renderNavbar, bindNavbar } from '../assets/ui.js';

    // üîê Sess√£o obrigat√≥ria
    requireAuth();

    // üîù Navbar
    const mount = document.getElementById('nav-mount');
    mount.innerHTML = renderNavbar('portal');
    bindNavbar();

    // üì∞ Garante pelo menos 1 not√≠cia
    ensureWelcomeSeed();

    // üß± Renderiza o novo feed de not√≠cias
    function renderFeedV3() {
      const host = document.querySelector('#news-feed');
      if (!host) return;

      let items = [];
      try { items = listNews(); } catch { items = []; }

      if (!items.length) {
        host.innerHTML = `<p class="muted">Nenhuma atualiza√ß√£o publicada ainda.</p>`;
        return;
      }

      // Normaliza formato (legado e novo)
      const norm = (n) => ({
        id: n.id,
        title: n.title ?? n.titulo ?? '',
        subtitle: n.subtitle ?? n.subtitulo ?? '',
        bodyHtml: n.bodyHtml ?? n.corpoHtml ?? n.body ?? '',
        thumb: n.thumb ?? n.thumbnail ?? '',
        ts: n.ts ?? n.criadoEm ?? Date.now()
      });

      const list = items.map(norm).sort((a, b) => (b.ts || 0) - (a.ts || 0));

      host.innerHTML = `
        <div class="feed-grid">
          ${list.map(p => `
            <article class="feed-card">
              ${p.thumb ? `<img class="feed-thumb" src="${p.thumb}" alt="">` : ``}
              <div class="feed-body">
                <div class="feed-title">${p.title}</div>
                ${p.subtitle ? `<div class="feed-sub">${p.subtitle}</div>` : ``}
                <div class="feed-meta">${new Date(p.ts).toLocaleDateString('pt-BR')}</div>
                <div class="feed-actions">
                  <a class="btn" href="/portal/news.html?id=${encodeURIComponent(p.id)}">Ler mais</a>
                </div>
              </div>
            </article>
          `).join('')}
        </div>
      `;
    }

    // Executa o render
    renderFeedV3();

    // üí¨ Notificador do mascote
    initMascotNotifier();
  </script>
</body>
</html>
