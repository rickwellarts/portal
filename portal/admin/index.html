<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin • Portal CCE</title>
  <link rel="stylesheet" href="/assets/style.css">

<script type="module" src="../admin/admin_news_publish.js"></script>
  <!-- SunEditor (grátis / MIT) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/suneditor/dist/css/suneditor.min.css">
  <script src="https://cdn.jsdelivr.net/npm/suneditor/dist/suneditor.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/suneditor@latest/dist/lang/pt.js"></script>

<script type="module">
  import { requireAuth } from '/assets/auth.js';
  (async () => {
    const u = await requireAuth();        // agora já retorna role vindo do Firestore
    if (u.role !== 'admin') {
      location.href = '/portal/index.html';
    }
  })();
</script>


  <!-- Navbar do Portal (só renderiza quando o DOM existir) -->
  <script type="module">
    import { renderNavbar, bindNavbar } from "/assets/ui.js";
    window.addEventListener('DOMContentLoaded', ()=>{
      const mount = document.getElementById('nav-mount');
      if (mount) {
        mount.innerHTML = renderNavbar('portal');
        bindNavbar();
      }
    });
  </script>
</head>
<body class="bg">

  <!-- (Opcional) Navbar do Portal -->
  <div id="nav-mount"></div>

  <!-- NAV do Admin -->
  <header class="navbar">
    <a href="#" class="btn tab" data-tab="noticias">Notícias</a>
    <a href="#" class="btn tab" data-tab="tokens">Tokens</a>
    <a href="#" class="btn tab" data-tab="relatorios">Relatórios</a>
    <a href="#" class="btn tab" data-tab="extrap">Extrapolações</a>
    <a href="#" class="btn tab" data-tab="usuarios">Usuários</a>
    <a class="btn" href="/portal/index.html">Portal</a>
  </header>

  <main class="container">
    <!-- NOTÍCIAS -->
    <section id="sec-noticias" class="card">
      <h2>Notícias</h2>

      <label for="titulo">Título</label>
      <input id="titulo" type="text" />

      <label for="subtitulo">Subtítulo</label>
      <input id="subtitulo" type="text" />

      <label for="editor">Corpo</label>
      <textarea id="editor"></textarea>


	<!-- Destaque -->
<div class="field" style="margin-top:12px">
  <label class="check">
    <input type="checkbox" id="flag-destaque" />
    Destaque
  </label>
</div>




      <!-- Capa (thumbnail) -->
      <div class="field" style="margin-top:12px">
        <label for="thumb-file">Capa (thumbnail)</label>
        <input id="thumb-file" type="file" accept="image/*" />
        <div id="thumb-preview" style="margin-top:8px;display:flex;gap:12px;align-items:center">
          <img id="thumb-img" alt="preview" style="max-width:260px;border-radius:12px;display:none" />
          <span id="thumb-hint" class="muted">Envie uma imagem 16:9 (ex.: 1280×720). Geramos a miniatura automaticamente.</span>
        </div>
      </div>

      <div class="actions" style="margin-top:16px">
        <button id="btn-publicar" class="btn">Publicar</button>
        <a href="/admin/news-list.html" target="_blank" class="btn ghost">Gerenciar notícias</a>


      </div>
    </section>

    <!-- TOKENS -->
    <section id="sec-tokens" class="card" hidden>
      <h2>Tokens</h2>
      <div id="tokens-panel"></div>
    </section>

    <!-- RELATÓRIOS -->
    <section id="sec-relatorios" class="card" hidden>
      <h2>Relatórios (últimos 7 dias)</h2>
      <div id="shift-reports"></div>
      <div id="cars-reports" style="margin-top:16px;"></div>
    </section>

    <!-- EXTRAPOLAÇÕES -->
    <section id="sec-extrap" class="card" hidden>
      <div class="card">
        <h2>Justificativas</h2>
        <div id="admin-justifs"></div>
      </div>
    </section>

    <!-- USUÁRIOS -->
    <section id="sec-usuarios" class="card" hidden>
      <h2>Usuários</h2>
      <div id="users-panel"></div>
    </section>
  </main>

  <!-- ====== SunEditor + Thumbnail + Publicar ====== -->
  <script>

// ===== Admin • Editor de Notícias (SunEditor) + Gerenciador =====
window.addEventListener('DOMContentLoaded', () => {
  // ---------- util localStorage ----------
  const LS_KEY = 'admin_noticias';
  const getList = () => { try { return JSON.parse(localStorage.getItem(LS_KEY)||'[]'); } catch { return []; } };
  const setList = (arr) => localStorage.setItem(LS_KEY, JSON.stringify(arr));

  // ---------- SunEditor ----------
  const el = document.getElementById('editor');
  if (!el || !window.SUNEDITOR) {
    console.error('SunEditor ou textarea #editor indisponível.');
    return;
  }

  const langPack = (window.SUNEDITOR_LANG && window.SUNEDITOR_LANG.pt)
    ? window.SUNEDITOR_LANG.pt
    : undefined;

  const editor = SUNEDITOR.create(el, {
    lang: langPack,
    height: 360,
    minHeight: '260px',
    buttonList: [
      ['undo','redo'],
      ['bold','underline','italic','strike','fontColor','hiliteColor'],
      ['align','list','outdent','indent'],
      ['link','image','video','table'],
      ['removeFormat','fullScreen','codeView']
    ],
    imageResizing: true,
    imageWidth: 'auto',
    resizingBar: true
  });

  // Upload de imagem inline (base64)
  editor.onImageUploadBefore = (files, info, core, uploadHandler) => {
    const f = files?.[0];
    if (!f) return;
    const reader = new FileReader();
    reader.onload = () => {
      uploadHandler({ result: [{ url: reader.result, name: f.name, size: f.size }] });
    };
    reader.readAsDataURL(f);
    return false; // bloqueia upload padrão
  };

  const getEditorHtml = () => editor.getContents(true);

  // ---------- Thumbnail 16:9 ----------
  const fileInput = document.getElementById('thumb-file');
  const imgPrev   = document.getElementById('thumb-img');
  const hint      = document.getElementById('thumb-hint');
  let thumbDataURL = "";

  fileInput?.addEventListener('change', async (e) => {
    const f = e.target.files?.[0];
    if (!f) return;
    const src = await fileToDataURL(f);
    thumbDataURL = await makeThumb169(src, 1280, 720);
    if (imgPrev) { imgPrev.src = thumbDataURL; imgPrev.style.display = 'block'; }
    if (hint) hint.style.display = 'none';
  });

  function fileToDataURL(file){
    return new Promise((res, rej) => {
      const r = new FileReader();
      r.onload = () => res(r.result);
      r.onerror = rej;
      r.readAsDataURL(file);
    });
  }
  async function makeThumb169(src, outW=1280, outH=720){
    const img = new Image();
    img.src = src;
    await img.decode();
    const W = img.naturalWidth, H = img.naturalHeight;
    const target = 16/9, ratio = W/H;
    let sx=0, sy=0, sw=W, sh=H;
    if (ratio > target){ sw = H * target; sx = (W - sw)/2; }
    else if (ratio < target){ sh = W / target; sy = (H - sh)/2; }
    const cv = document.createElement('canvas');
    cv.width = outW; cv.height = outH;
    cv.getContext('2d').drawImage(img, sx, sy, sw, sh, 0, 0, outW, outH);
    return cv.toDataURL('image/jpeg', 0.85);
  }

  // ---------- Publicar ----------
  const btnPublicar  = document.getElementById('btn-publicar');
  const chkDestaque  = document.getElementById('flag-destaque');

  btnPublicar?.addEventListener('click', () => {
    const titulo = document.getElementById('titulo')?.value.trim();
    const subtitulo = document.getElementById('subtitulo')?.value.trim();
    const corpoHtml = getEditorHtml();
    const destaque  = !!chkDestaque?.checked;

    if (!titulo || !corpoHtml){
      alert('Preencha título e corpo.');
      return;
    }

    const lista = getList();
    lista.push({
      id: Date.now(),
      titulo,
      subtitulo,
      corpoHtml,
      thumb: thumbDataURL || null,
      destaque,
      criadoEm: Date.now()
    });
    setList(lista);
    alert('Notícia publicada!');
  });

  // ---------- Gerenciar notícias (modal) ----------
  const btnGerenciar = document.getElementById('btn-gerenciar');
  btnGerenciar?.addEventListener('click', openNewsManager);

  function openNewsManager(){
    const lista = getList().sort((a,b)=> b.criadoEm - a.criadoEm);
    const html = `
      <div class="news-mgr" style="display:flex;flex-direction:column;gap:10px;max-height:60vh;overflow:auto">
        ${lista.length ? '' : '<p class="muted">Nenhuma notícia publicada ainda.</p>'}
        ${lista.map(n => `
          <div class="news-row" data-id="${n.id}" style="display:grid;grid-template-columns:64px 1fr auto auto;gap:10px;align-items:center;border:1px solid rgba(255,255,255,.08);padding:8px;border-radius:10px;">
            <div style="width:64px;height:36px;background:#111;border-radius:6px;overflow:hidden;display:flex;align-items:center;justify-content:center">
              ${n.thumb ? `<img src="${n.thumb}" style="width:100%;height:100%;object-fit:cover" alt="">` : '<span class="muted" style="font-size:11px">sem capa</span>'}
            </div>
            <div>
              <div style="font-weight:600">${escapeHtml(n.titulo||'—')}</div>
              <div class="muted" style="font-size:12px">${new Date(n.criadoEm).toLocaleString('pt-BR')}</div>
            </div>
            <button class="btn ghost btn-toggle" title="Alternar destaque">${n.destaque ? 'Remover destaque' : 'Destacar'}</button>
            <button class="btn ghost btn-del" title="Excluir">Excluir</button>
          </div>
        `).join('')}
      </div>
    `;

    // openModal já existe no admin (seu modal base)
    window.openModal({
      title: "Gerenciar notícias",
      message: html,
      showCancel: false,
      okText: "Fechar"
    });

    // Anexa handlers após o modal abrir
    // (o conteúdo está dentro do #cce-modal)
    setTimeout(() => {
      const root = document.querySelector('#cce-modal .news-mgr');
      if (!root) return;

      root.addEventListener('click', (e) => {
        const row = e.target.closest('.news-row');
        if (!row) return;
        const id = Number(row.dataset.id);
        if (e.target.classList.contains('btn-del')) {
          if (!confirm('Excluir esta notícia?')) return;
          const arr = getList().filter(x => x.id !== id);
          setList(arr);
          row.remove();
        }
        if (e.target.classList.contains('btn-toggle')) {
          const arr = getList();
          const ix = arr.findIndex(x => x.id === id);
          if (ix >= 0) {
            arr[ix].destaque = !arr[ix].destaque;
            setList(arr);
            e.target.textContent = arr[ix].destaque ? 'Remover destaque' : 'Destacar';
          }
        }
      });
    }, 0);
  }

  // ---------- helpers ----------
  function escapeHtml(s){
    return String(s||'')
      .replace(/&/g,'&amp;').replace(/</g,'&lt;')
      .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }
});

  </script>

  <!-- MÓDULOS DO ADMIN -->
  <script type="module" src="/assets/admin_news.js"></script>
  <script type="module">
    import { bindTokens, renderReportsPanel, bindUsers, bindExtrapolations } from '/assets/admin_panels.js';
    (function(){
      const tabs = ['noticias','tokens','relatorios','extrap','usuarios'];
      const btns = document.querySelectorAll('.tab');
      function show(tab){
        tabs.forEach(t=>{
          const sec = document.getElementById('sec-'+t);
          if (sec) sec.hidden = (t !== tab);
        });
        btns.forEach(b=> b.classList.toggle('btn-primary', b.dataset.tab===tab));
        location.hash = tab;
        if (tab==='tokens')      bindTokens(document);
        if (tab==='relatorios')  renderReportsPanel(document);
        if (tab==='usuarios')    bindUsers(document);
        if (tab==='extrap')      bindExtrapolations(document);
      }
      btns.forEach(b=> b.addEventListener('click', e=>{ e.preventDefault(); show(b.dataset.tab); }));
      const initial = (location.hash||'').slice(1);
      show(tabs.includes(initial) ? initial : 'noticias');
    })();
  </script>

  <script src="/admin/admin-justifs.js"></script>

  <!-- Modal base do Portal (reuso no Admin) -->
  <div id="cce-modal" class="cce-modal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="cce-modal-title">
    <div class="cce-modal__backdrop" data-close="true"></div>
    <div class="cce-modal__dialog" role="document">
      <h3 id="cce-modal-title" class="cce-modal__title">Confirmação</h3>
      <p id="cce-modal-msg" class="cce-modal__msg">Mensagem…</p>
      <div class="cce-modal__actions">
        <button type="button" class="btn ghost" data-action="cancelar">Cancelar</button>
        <button type="button" class="btn" data-action="ok" id="cce-modal-ok">OK</button>
      </div>
      <button class="cce-modal__x" aria-label="Fechar" data-close="true">×</button>
    </div>
  </div>

  <script>
    // helper mínimo para abrir modal no Admin
    (function(){
      const modalEl = document.getElementById('cce-modal');
      const titleEl = document.getElementById('cce-modal-title');
      const msgEl   = document.getElementById('cce-modal-msg');
      const btnOk   = modalEl.querySelector('[data-action="ok"]');
      const btnCan  = modalEl.querySelector('[data-action="cancelar"]');

      window.openModal = function({title="Detalhes", message="", showCancel=false, okText="Fechar"}){
        return new Promise((resolve)=>{
          titleEl.textContent = title;
          msgEl.innerHTML = message;
          btnOk.textContent = okText;
          btnCan.style.display = showCancel ? "" : "none";
          modalEl.setAttribute("aria-hidden","false");

          function close(v){
            modalEl.setAttribute("aria-hidden","true");
            modalEl.removeEventListener("click", onClick);
            document.removeEventListener("keydown", onKey);
            resolve(v);
          }
          function onClick(e){
            if (e.target.dataset.close === "true") return close(false);
            const act = e.target.closest('[data-action]')?.dataset.action;
            if (act === 'ok')       return close(true);
            if (act === 'cancelar') return close(false);
          }
          function onKey(e){
            if (e.key === "Escape") close(false);
            if (e.key === "Enter")  close(true);
          }
          modalEl.addEventListener("click", onClick);
          document.addEventListener("keydown", onKey);
          setTimeout(()=>btnOk.focus(),0);
        });
      };
    })();
  </script>
</body>
</html>